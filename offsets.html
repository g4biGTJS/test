<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Offsets - Glacier</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="loading">
    <div class="spinner"></div>
  </div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-logo"><span>Glacier</span></div>
    <div class="nav-links">
      <a href="index.html" class="nav-link">Home</a>
      <a href="download.html" class="nav-link">Download</a>
      <a href="offsets.html" class="nav-link active">Offsets</a>
      <a href="team.html" class="nav-link">Team</a>
    </div>
  </nav>

  <div class="dark-overlay"></div>
  <div class="pumpkin">ðŸŽƒ</div>
  <div class="pumpkin">ðŸŽƒ</div>
  <div class="pumpkin">ðŸŽƒ</div>

  <div class="particles">
    <div class="particle"></div><div class="particle"></div><div class="particle"></div>
    <div class="particle"></div><div class="particle"></div><div class="particle"></div>
    <div class="particle"></div><div class="particle"></div>
  </div>

  <div class="page active">
    <div class="container offsets-container">
      <h1 class="title">Offsets</h1>
      <p class="subtitle">Current Roblox offsets and version information</p>

      <div class="main-content">
        <div class="version-display">
          <h2 class="changelog-title">Current Roblox Version</h2>
          <div class="version-box" id="versionBox">
            <div class="version-status" id="versionStatus">Loading...</div>
            <div class="version-text" id="versionText">...</div>
          </div>
          <p class="last-checked">Last checked: <span id="lastChecked">Never</span></p>
        </div>

        <div class="offsets-section">
          <h2 class="changelog-title">Windows Offsets</h2>
          <div class="offsets-box" id="offsetsBox">
            <pre id="offsetsContent">Loading offsets...</pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification">
    <div class="notification-title">All Systems Operational</div>
    <div class="notification-text">Everything running smoothly!</div>
  </div>

  <script>
    // ===============================
    // CONFIG
    // ===============================
    const ROBLOX_VERSION_KEY = 'roblox_current_version';
    const UPDATE_TIMESTAMP_KEY = 'roblox_update_timestamp';
    const FLASH_DURATION_MS = 3600000; // 1 hour
    const OFFSETS_PATH = 'offsets/windows-offsets.txt';

    // âœ… Single API URL (CORS-safe through AllOrigins)
    const VERSION_API = 'https://api.allorigins.win/raw?url=https://clientsettingscdn.roblox.com/v2/client-version/WindowsPlayer';

    // ===============================
    // UI HELPERS
    // ===============================
    function setStatus(status, version, box, statusEl, textEl) {
      textEl.textContent = version;
      box.className = `version-box ${status}`;
      statusEl.textContent =
        status === 'updated' ? 'Recently Updated' :
        status === 'current' ? 'Current Version' :
        'Error';
    }

    // ===============================
    // FETCH ROBLOX VERSION
    // ===============================
    async function fetchRobloxVersion() {
      const versionBox = document.getElementById('versionBox');
      const versionText = document.getElementById('versionText');
      const versionStatus = document.getElementById('versionStatus');
      const lastChecked = document.getElementById('lastChecked');

      lastChecked.textContent = new Date().toLocaleString();

      try {
        const response = await fetch(VERSION_API);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        // Parse JSON response
        const data = await response.json();
        const currentVersion = data.clientVersionUpload || 'Unknown';

        // Local storage logic
        const storedVersion = localStorage.getItem(ROBLOX_VERSION_KEY);
        let updateTimestamp = parseInt(localStorage.getItem(UPDATE_TIMESTAMP_KEY)) || 0;
        let status = 'current';
        const timeSinceUpdate = Date.now() - updateTimestamp;

        if (storedVersion && currentVersion !== storedVersion) {
          localStorage.setItem(ROBLOX_VERSION_KEY, currentVersion);
          updateTimestamp = Date.now();
          localStorage.setItem(UPDATE_TIMESTAMP_KEY, updateTimestamp);
          status = 'updated';
        } else if (timeSinceUpdate < FLASH_DURATION_MS && updateTimestamp > 0) {
          status = 'updated';
        } else if (!storedVersion) {
          localStorage.setItem(ROBLOX_VERSION_KEY, currentVersion);
          localStorage.setItem(UPDATE_TIMESTAMP_KEY, Date.now());
          status = 'updated';
        }

        setStatus(status, currentVersion, versionBox, versionStatus, versionText);

        if (status === 'updated') {
          setTimeout(() => {
            setStatus('current', currentVersion, versionBox, versionStatus, versionText);
          }, FLASH_DURATION_MS);
        }

      } catch (error) {
        console.error('Error fetching Roblox version:', error);
        const cached = localStorage.getItem(ROBLOX_VERSION_KEY);
        if (cached) {
          setStatus('current', cached + ' (cached)', versionBox, versionStatus, versionText);
        } else {
          setStatus('error', 'Failed to load version', versionBox, versionStatus, versionText);
        }
      }
    }

    // ===============================
    // OFFSETS LOADER
    // ===============================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function highlightCppSyntax(text) {
      let res = escapeHtml(text);
      res = res.replace(/\b(0x[0-9A-Fa-f]+)\b/g, '<span class="syntax-hex">$1</span>');
      res = res.replace(/\b(namespace|inline|constexpr)\b/g, '<span class="syntax-keyword">$1</span>');
      res = res.replace(/\b(uintptr_t)\b/g, '<span class="syntax-type">$1</span>');
      res = res.replace(/\b([A-Z][a-zA-Z0-9_]*)\b(\s*=)/g, '<span class="syntax-identifier">$1</span>$2>');
      res = res.replace(/([{}])/g, '<span class="syntax-brace">$1</span>');
      return res;
    }

    async function loadOffsets() {
      try {
        const res = await fetch(OFFSETS_PATH + '?t=' + Date.now());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const txt = await res.text();
        if (!txt.trim()) throw new Error('Empty file');
        document.getElementById('offsetsContent').innerHTML = highlightCppSyntax(txt);
      } catch (e) {
        document.getElementById('offsetsContent').innerHTML =
          `<span style="color:#ff6b6b;">Error loading offsets: ${e.message}<br>File missing: ${OFFSETS_PATH}</span>`;
      }
    }

    // ===============================
    // ON PAGE LOAD
    // ===============================
    window.addEventListener('load', () => {
      const box = document.getElementById('versionBox');
      const statusEl = document.getElementById('versionStatus');
      const textEl = document.getElementById('versionText');
      const current = localStorage.getItem(ROBLOX_VERSION_KEY) || 'Unknown';
      setStatus('current', current, box, statusEl, textEl);

      const loading = document.querySelector('.loading');
      loading.style.animation = 'fadeOut 1s ease 0.5s forwards';
      setTimeout(() => (loading.style.display = 'none'), 1500);
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadOffsets();
      fetchRobloxVersion();
      setInterval(fetchRobloxVersion, 60000);
      setInterval(loadOffsets, 300000);
    });
  </script>
</body>
</html>
